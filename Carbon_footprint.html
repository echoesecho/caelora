<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waste Classifier</title>
    <style>
        /* Basic CSS for layout and styling */
        body { font-family: sans-serif; margin: 20px; }
        #camera-feed, #captured-image { max-width: 100%; height: auto; border: 1px solid #ccc; margin-bottom: 10px; }
        #classification-result { font-size: 1.2em; font-weight: bold; margin-top: 15px; }
        #disposal-guidance { margin-top: 10px; padding: 10px; border: 1px dashed #eee; background-color: #f9f9f9; }
        #history-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .history-item { display: flex; align-items: center; margin-bottom: 10px; padding: 5px; border: 1px solid #ddd; }
        .history-item img { width: 60px; height: 60px; object-fit: cover; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Smart Waste Classifier</h1>

    <section>
        <h2>Upload or Capture Waste Image</h2>
        <input type="file" id="imageUpload" accept="image/*">
        <button id="captureButton">Open Camera</button>
        <button id="closeCameraButton" style="display:none;">Close Camera</button>

        <video id="camera-feed" autoplay style="display:none;"></video>
        <canvas id="captured-image" style="display:none;"></canvas>
        <button id="processCameraButton" style="display:none;">Analyze Photo</button>

        <img id="previewImage" src="" alt="Image Preview" style="max-width: 300px; display: none;">
        <button id="classifyButton" style="display: none;">Classify Waste</button>
    </section>

    <section id="results-section" style="display:none;">
        <h2>Classification Result:</h2>
        <p id="classification-result"></p>
        <div id="disposal-guidance">
            </div>
    </section>

    <section id="history-section">
        <h2>History</h2>
        <button id="clearHistoryButton">Clear History</button>
        <div id="history-list">
            </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script>
        // JavaScript for handling file upload, camera, classification, and history
        const imageUpload = document.getElementById('imageUpload');
        const previewImage = document.getElementById('previewImage');
        const classifyButton = document.getElementById('classifyButton');
        const classificationResult = document.getElementById('classification-result');
        const disposalGuidance = document.getElementById('disposal-guidance');
        const historyList = document.getElementById('history-list');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const resultsSection = document.getElementById('results-section');

        const captureButton = document.getElementById('captureButton');
        const closeCameraButton = document.getElementById('closeCameraButton');
        const cameraFeed = document.getElementById('camera-feed');
        const capturedImageCanvas = document.getElementById('captured-image');
        const processCameraButton = document.getElementById('processCameraButton');
        const ctx = capturedImageCanvas.getContext('2d');

        let model; // To hold the loaded TensorFlow.js model

        // --- Load AI Model (Example - Replace with your actual model loading) ---
        async function loadModel() {
            // If using a pre-trained model like MobileNet for demonstration
            // model = await tf.loadGraphModel('https://tfhub.dev/google/imagenet/mobilenet_v2_100_224/classification/2', { fromTFHub: true });
            // For your custom waste classifier, load your converted TF.js model:
            // model = await tf.loadLayersModel('path/to/your/model.json');
            console.log("AI model loaded (placeholder).");
            // For this example, we'll simulate a model
            return true;
        }

        // --- Image Handling ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    classifyButton.style.display = 'block';
                    // Hide camera elements if file is uploaded
                    cameraFeed.style.display = 'none';
                    capturedImageCanvas.style.display = 'none';
                    processCameraButton.style.display = 'none';
                    closeCameraButton.style.display = 'none';
                    captureButton.style.display = 'block'; // Show "Open Camera" again
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.style.display = 'none';
                classifyButton.style.display = 'none';
            }
        });

        // --- Camera Handling ---
        let mediaStream;
        captureButton.addEventListener('click', async () => {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraFeed.srcObject = mediaStream;
                cameraFeed.style.display = 'block';
                capturedImageCanvas.style.display = 'none'; // Hide canvas initially
                processCameraButton.style.display = 'block';
                closeCameraButton.style.display = 'block';
                captureButton.style.display = 'none'; // Hide "Open Camera" button
                previewImage.style.display = 'none'; // Hide uploaded image preview
                classifyButton.style.display = 'none'; // Hide classify button for uploaded image
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access camera. Please ensure permissions are granted.");
            }
        });

        closeCameraButton.addEventListener('click', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraFeed.style.display = 'none';
                capturedImageCanvas.style.display = 'none';
                processCameraButton.style.display = 'none';
                closeCameraButton.style.display = 'none';
                captureButton.style.display = 'block'; // Show "Open Camera" button again
                previewImage.style.display = 'none';
                classifyButton.style.display = 'none';
            }
        });

        processCameraButton.addEventListener('click', () => {
            // Set canvas dimensions to match video feed
            capturedImageCanvas.width = cameraFeed.videoWidth;
            capturedImageCanvas.height = cameraFeed.videoHeight;
            ctx.drawImage(cameraFeed, 0, 0, capturedImageCanvas.width, capturedImageCanvas.height);
            capturedImageCanvas.style.display = 'block'; // Show the captured image
            
            // Get image data from canvas and simulate classification
            const imageDataURL = capturedImageCanvas.toDataURL('image/jpeg');
            simulateClassification(imageDataURL);

            // Optionally, stop camera feed after capture
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraFeed.style.display = 'none';
                closeCameraButton.style.display = 'none';
                processCameraButton.style.display = 'none';
                captureButton.style.display = 'block'; // Show "Open Camera" again
            }
        });


        // --- Classification Logic (Simulated for this HTML example) ---
        classifyButton.addEventListener('click', () => {
            if (previewImage.src) {
                simulateClassification(previewImage.src);
            } else {
                alert("Please upload an image or capture one from the camera first.");
            }
        });

        // Simulates AI/ML classification (replace with actual model inference)
        async function simulateClassification(imageDataURL) {
            resultsSection.style.display = 'block';
            classificationResult.textContent = 'Classifying...';
            disposalGuidance.innerHTML = '';

            // Simulate a delay for classification
            await new Promise(resolve => setTimeout(resolve, 1500));

            // In a real scenario, you'd pass imageDataURL to your TF.js model or send to a backend API
            // For demonstration, we'll randomly pick a category
            const categories = ['Recyclable', 'Organic', 'General'];
            const predictedCategory = categories[Math.floor(Math.random() * categories.length)];

            displayClassificationResult(predictedCategory, imageDataURL);
        }

        function displayClassificationResult(category, imageDataURL) {
            classificationResult.textContent = `Classified as: ${category}`;
            let guidance = '';

            switch (category) {
                case 'Recyclable':
                    guidance = `
                        <p><strong>Great! This item is recyclable.</strong></p>
                        <p>Remember to rinse containers and remove food residue. Check your local recycling guidelines for specific instructions, as rules vary by region (e.g., plastic types, glass, paper). Many communities accept:</p>
                        <ul>
                            <li>Plastic bottles and containers (check numbers 1 & 2 primarily)</li>
                            <li>Glass bottles and jars</li>
                            <li>Aluminum and steel cans</li>
                            <li>Paper and cardboard</li>
                        </ul>
                        <p><small>Proper recycling helps conserve resources and reduce landfill waste.</small></p>
                    `;
                    break;
                case 'Organic':
                    guidance = `
                        <p><strong>This is organic waste!</strong></p>
                        <p>It can be composted. Composting turns food scraps and yard waste into nutrient-rich soil, reducing methane emissions from landfills. Ideal for:</p>
                        <ul>
                            <li>Fruit and vegetable scraps</li>
                            <li>Coffee grounds and tea bags</li>
                            <li>Eggshells</li>
                            <li>Yard trimmings (leaves, grass clippings)</li>
                        </ul>
                        <p><small>Consider starting a home compost bin or look for community composting programs!</small></p>
                    `;
                    break;
                case 'General':
                    guidance = `
                        <p><strong>This item belongs in general waste.</strong></p>
                        <p>While not recyclable or compostable, please ensure it's disposed of properly in a designated general waste bin. Examples of general waste include:</p>
                        <ul>
                            <li>Ceramics and broken dishes</li>
                            <li>Diapers and hygiene products</li>
                            <li>Plastic bags (often not accepted in curbside recycling)</li>
                            <li>Styrofoam</li>
                        </ul>
                        <p><small>Always aim to reduce general waste where possible by choosing reusable alternatives.</small></p>
                    `;
                    break;
            }
            disposalGuidance.innerHTML = guidance;

            saveToHistory(imageDataURL, category);
        }

        // --- History Management ---
        function saveToHistory(imageDataURL, category) {
            let history = JSON.parse(localStorage.getItem('wasteHistory')) || [];
            history.unshift({ // Add to the beginning for most recent first
                image: imageDataURL,
                category: category,
                timestamp: new Date().toLocaleString()
            });
            // Keep history to a reasonable size, e.g., last 10-20 items
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            localStorage.setItem('wasteHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = ''; // Clear current list
            const history = JSON.parse(localStorage.getItem('wasteHistory')) || [];

            if (history.length === 0) {
                historyList.innerHTML = '<p>No history yet.</p>';
                return;
            }

            history.forEach(item => {
                const historyItemDiv = document.createElement('div');
                historyItemDiv.classList.add('history-item');

                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.category;

                const textSpan = document.createElement('span');
                textSpan.textContent = `${item.category} - ${item.timestamp}`;

                historyItemDiv.appendChild(img);
                historyItemDiv.appendChild(textSpan);
                historyList.appendChild(historyItemDiv);
            });
        }

        clearHistoryButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to delete all your history? This action cannot be undone.")) {
                localStorage.removeItem('wasteHistory');
                renderHistory();
                alert("History cleared!");
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadModel(); // Start loading your AI model
            renderHistory(); // Display existing history
        });

    </script>
</body>
</html>
