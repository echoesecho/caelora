<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waste Classifier</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-grey background */
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* Softer shadow */
        }
        .upload-area {
            border: 3px dashed #cbd5e1; /* Lighter dashed border */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .upload-area:hover {
            border-color: #94a3b8; /* Darker on hover */
        }
        .btn-primary {
            background-color: #4f46e5; /* Deeper purple */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded button */
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker purple on hover */
            transform: translateY(-2px); /* Slight lift */
        }
        .btn-secondary {
            background-color: #64748b; /* Slate grey */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #475569; /* Darker slate on hover */
            transform: translateY(-2px);
        }
        .history-item {
            background-color: #eff6ff; /* Lightest blue for history items */
            border-left: 5px solid #6366f1; /* Accent border */
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom message box styles */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            max-width: 400px;
            text-align: center;
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Hidden by default */
        }
        .message-box-close-btn {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .message-box-close-btn:hover {
            background-color: #4338ca;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-4">Smart Waste Classifier</h1>
        <p class="text-center text-gray-600 mb-8">Upload or take a photo of waste, or paste an image from your clipboard, to get it classified and learn how to dispose of it responsibly.</p>

        <!-- Image Upload Section -->
        <div class="mb-8">
            <label for="imageUpload" class="upload-area block cursor-pointer">
                <input type="file" id="imageUpload" accept="image/*" class="hidden">
                <p class="text-gray-500 mb-2">Click to upload an image, drag and drop here, or paste from clipboard</p>
                <img id="imagePreview" src="https://placehold.co/300x200/e0e7ff/6366f1?text=Image+Preview" alt="Image Preview" class="max-w-full h-auto mx-auto mt-4 rounded-lg shadow-md" style="max-height: 300px; object-fit: contain;">
            </label>
            <div class="flex justify-center mt-6 space-x-4">
                <button id="classifyBtn" class="btn-primary">Classify Waste</button>
                <button id="clearImageBtn" class="btn-secondary">Clear Image</button>
            </div>
        </div>

        <!-- Classification Result Section -->
        <div id="resultSection" class="bg-blue-50 p-6 rounded-xl shadow-lg mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">Classification Result</h2>
            <div id="loadingIndicator" class="flex items-center justify-center space-x-3 hidden">
                <div class="loader"></div>
                <p class="text-blue-600 text-lg">Classifying...</p>
            </div>
            <p id="classificationResult" class="text-xl font-bold text-blue-700 mb-2"></p>
            <p id="disposalTip" class="text-gray-700 text-lg"></p>
            <div class="flex justify-start mt-4">
                <button id="copyToClipboardBtn" class="btn-secondary text-sm">Copy Result</button>
            </div>
        </div>

        <!-- History Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Classification History</h2>
            <div id="historyList" class="space-y-4">
                <!-- History items will be loaded here by JavaScript -->
                <p id="noHistoryMessage" class="text-gray-500 text-center">No history yet. Classify some waste!</p>
            </div>
            <div class="flex justify-center mt-6">
                <button id="clearHistoryBtn" class="btn-secondary">Clear History</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBoxOverlay" class="message-box-overlay"></div>
    <div id="messageBox" class="message-box">
        <p id="messageBoxText" class="text-lg text-gray-800"></p>
        <button id="messageBoxCloseBtn" class="message-box-close-btn">OK</button>
    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const classifyBtn = document.getElementById('classifyBtn');
        const clearImageBtn = document.getElementById('clearImageBtn'); // New button
        const resultSection = document.getElementById('resultSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const classificationResult = document.getElementById('classificationResult');
        const disposalTip = document.getElementById('disposalTip');
        const historyList = document.getElementById('historyList');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');

        const messageBox = document.getElementById('messageBox');
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        let uploadedImageBase64 = ''; // Stores the base64 string of the uploaded image

        // Function to show a custom message box (kept for other general messages)
        function showMessageBox(message) {
            messageBoxText.textContent = message;
            messageBox.style.display = 'block';
            messageBoxOverlay.style.display = 'block';
        }

        // Function to hide the custom message box
        function hideMessageBox() {
            messageBox.style.display = 'none';
            messageBoxOverlay.style.display = 'none';
        }

        // Event listener for message box close button
        messageBoxCloseBtn.addEventListener('click', hideMessageBox);
        messageBoxOverlay.addEventListener('click', hideMessageBox); // Close when clicking clicking outside

        // Handle image file selection
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                processImageFile(file);
            } else {
                imagePreview.src = "https://placehold.co/300x200/e0e7ff/6366f1?text=Image+Preview";
                uploadedImageBase64 = '';
            }
        });

        // Function to process an image file (either from input or clipboard)
        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                uploadedImageBase64 = e.target.result.split(',')[1]; // Get base64 part only
                resultSection.classList.add('hidden'); // Hide previous results
            };
            reader.readAsDataURL(file);
        }

        // Handle drag and drop for image upload
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-500');
        });
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                imageUpload.files = e.dataTransfer.files; // Assign dropped file to input (optional, but good for consistency)
                processImageFile(file);
            } else {
                showMessageBox('Please drop an image file.');
            }
        });

        // Handle paste event for image upload from clipboard
        document.addEventListener('paste', (e) => {
            // Check if any items in clipboard are files (images)
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    if (file) {
                        processImageFile(file);
                        showMessageBox('Image pasted from clipboard!');
                        e.preventDefault(); // Prevent default paste action (e.g., pasting text)
                        return; // Stop after finding the first image
                    }
                }
            }
        });

        // Classify Waste Function
        classifyBtn.addEventListener('click', async () => {
            if (!uploadedImageBase64) {
                showMessageBox('Please upload or paste an image first.');
                return;
            }

            resultSection.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            
            // Randomly pick a placeholder classification for immediate display
            const classifications = ['Recyclable', 'Organic', 'General'];
            const randomClassification = classifications[Math.floor(Math.random() * classifications.length)];
            
            classificationResult.textContent = `Type: ${randomClassification}`;
            disposalTip.textContent = `Tip: Analyzing image...`;


            try {
                const prompt = "Classify the waste type in this image as one of the following: 'Recyclable', 'Organic', or 'General'. Also, provide a short, single-sentence tip for responsible disposal for this specific waste type. Respond in JSON format with two keys: 'classification' and 'disposalTip'.";
                
                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "image/png", // Assuming PNG, adjust if needed
                                        data: uploadedImageBase64
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "classification": { "type": "STRING" },
                                "disposalTip": { "type": "STRING" }
                            },
                            "propertyOrdering": ["classification", "disposalTip"]
                        }
                    }
                };
                
                // Gemini API call (ensure your API key is correctly handled in the Canvas environment)
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                    const classification = jsonResponse.classification;
                    const tip = jsonResponse.disposalTip;

                    classificationResult.textContent = `Type: ${classification}`;
                    disposalTip.textContent = `Tip: ${tip}`;

                    saveHistory(imagePreview.src, classification, tip);
                    displayHistory();

                } else {
                    // Handle API response issues by updating the UI directly
                    classificationResult.textContent = `Type: Unclassified`;
                    disposalTip.textContent = `Tip: Could not classify the image. Please try another one.`;
                    console.error('Unexpected API response structure or no candidates:', result);
                }

            } catch (error) {
                // Handle fetch/network errors by updating the UI directly
                classificationResult.textContent = `Type: Error`;
                disposalTip.textContent = `Tip: An error occurred. Please try again.`;
                console.error('Classification error:', error);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // Clear Image from preview
        clearImageBtn.addEventListener('click', () => {
            imagePreview.src = "https://placehold.co/300x200/e0e7ff/6366f1?text=Image+Preview";
            uploadedImageBase64 = '';
            resultSection.classList.add('hidden');
            classificationResult.textContent = '';
            disposalTip.textContent = '';
            showMessageBox('Image cleared from preview.');
        });


        // Save classification to local storage
        function saveHistory(imageDataUrl, classification, tip) {
            const history = JSON.parse(localStorage.getItem('wasteHistory')) || [];
            const timestamp = new Date().toLocaleString();
            history.unshift({ imageDataUrl, classification, tip, timestamp }); // Add to beginning
            localStorage.setItem('wasteHistory', JSON.stringify(history));
        }

        // Display history from local storage
        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('wasteHistory')) || [];
            historyList.innerHTML = ''; // Clear current list

            if (history.length === 0) {
                noHistoryMessage.classList.remove('hidden');
            } else {
                noHistoryMessage.classList.add('hidden');
                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('history-item', 'flex', 'items-center', 'space-x-4');
                    historyItem.innerHTML = `
                        <img src="${item.imageDataUrl}" alt="Waste Image" class="w-16 h-16 object-cover rounded-md shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-700">Type: ${item.classification}</p>
                            <p class="text-sm text-gray-600">${item.tip}</p>
                            <p class="text-xs text-gray-400 mt-1">Classified on: ${item.timestamp}</p>
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });
            }
        }

        // Clear History
        clearHistoryBtn.addEventListener('click', () => {
            localStorage.removeItem('wasteHistory');
            displayHistory();
            showMessageBox('Classification history has been cleared.');
        });

        // Copy to Clipboard
        copyToClipboardBtn.addEventListener('click', () => {
            const textToCopy = `Classification: ${classificationResult.textContent}\n${disposalTip.textContent}`;
            
            // Fallback for older browsers or environments without navigator.clipboard
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessageBox('Result copied to clipboard!');
                } else {
                    showMessageBox('Failed to copy to clipboard.');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showMessageBox('Failed to copy to clipboard (browser support issue).');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        });

        // Load history on page load
        window.onload = displayHistory;

    </script>
</body>
</html>
