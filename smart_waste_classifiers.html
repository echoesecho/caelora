<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waste Classifier</title>

    <style>
        /* General Body & Root Styling */
        :root {
            --primary-green: #4CAF50; /* A vibrant green for main actions */
            --primary-green-dark: #45a049;
            --blue-paste: #2196F3; /* A friendly blue for paste */
            --blue-paste-dark: #1976D2;
            --red-clear: #F44336; /* A clear red for clear actions */
            --red-clear-dark: #D32F2F;
            --background-light: #F0F2F5; /* Light background for the page */
            --card-background: #FFFFFF; /* White for card backgrounds */
            --text-dark: #333;
            --text-medium: #555;
            --text-light: #777;
            --border-light: #EEE;
            --shadow-soft: rgba(0, 0, 0, 0.1);
            --border-dashed: #ADD8E6; /* Light blue for dashed border */
            --result-bg-light: #E8F5E9; /* Very light green for result section */
            --result-text-dark: #1B5E20; /* Darker green for result text */
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align content to the top */
            min-height: 100vh;
            background-color: var(--background-light);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-medium);
        }

        /* Main Container */
        .container {
            background-color: var(--card-background);
            padding: 35px;
            border-radius: 15px; /* More rounded corners */
            box-shadow: 0 10px 30px var(--shadow-soft); /* Enhanced shadow */
            text-align: center;
            width: 100%;
            max-width: 700px; /* Slightly wider */
            margin: 20px 0;
        }

        h1 {
            color: var(--text-dark);
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        h2 {
            color: var(--text-dark);
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 600;
        }

        /* Card Styling for Sections */
        .card {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Subtle inner shadow */
            margin-bottom: 25px;
            border: 1px solid var(--border-light); /* Light border */
        }

        /* Specific Section Styles */
        .upload-section {
            border: 2px dashed var(--border-dashed); /* Light blue dashed border */
            background-color: #F8FDFF; /* Very light blue background */
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px; /* Space between buttons */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            margin-top: 20px;
        }

        .action-button {
            display: inline-block;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px; /* Slightly more rounded buttons */
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-decoration: none; /* For label acting as button */
        }

        .action-button:active {
            transform: translateY(1px); /* Slight press effect */
        }

        .upload-button {
            background-color: var(--primary-green);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .upload-button:hover {
            background-color: var(--primary-green-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .paste-button {
            background-color: var(--blue-paste);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .paste-button:hover {
            background-color: var(--blue-paste-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }

        .hidden-input {
            display: none; /* Hide the actual file input */
        }

        .upload-hint {
            margin-top: 20px;
            color: var(--text-light);
            font-size: 0.9em;
        }

        /* Image Preview */
        .image-preview {
            min-height: 250px; /* Taller preview area */
            display: flex;
            flex-direction: column; /* Stack image and text */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #FDFDFD;
            position: relative;
            border: 1px dashed #CCC; /* Lighter dashed border for preview */
        }

        .image-preview img {
            max-width: 100%;
            max-height: 220px;
            display: none; /* Hidden by default */
            border-radius: 8px;
            object-fit: contain;
            margin-top: 10px; /* Space from H2 */
        }

        #noImageText {
            color: var(--text-light);
            font-style: italic;
            font-size: 1.1em;
            position: absolute; /* Position over the preview area */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Classify Button */
        .classify-button {
            background-color: var(--primary-green);
            padding: 18px 40px;
            font-size: 1.4em;
            box-shadow: 0 7px 20px rgba(76, 175, 80, 0.4);
            margin-bottom: 35px;
        }

        .classify-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .classify-button:hover:not(:disabled) {
            background-color: var(--primary-green-dark);
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.5);
        }

        /* Result Section */
        .result-section {
            background-color: var(--result-bg-light); /* Light green background */
            border: 1px solid #C8E6C9; /* Matching border */
        }

        #classificationResult {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--result-text-dark);
            margin-bottom: 20px;
        }

        #disposalTips {
            text-align: left;
            margin-top: 25px;
            color: var(--text-medium);
        }

        #disposalTips h3 {
            color: var(--result-text-dark);
            margin-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
        }

        #disposalTips p {
            margin-bottom: 10px;
            line-height: 1.7;
        }

        /* History Section */
        .history-section {
            background-color: #FDFDFD; /* Very light background */
            border: 1px solid #E0E0E0;
            text-align: left;
        }

        #historyList {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
            max-height: 250px; /* Taller history scroll area */
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: #FFFFFF;
        }

        #historyList li {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-medium);
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #historyList li:last-child {
            border-bottom: none;
        }

        .clear-button {
            background-color: var(--red-clear);
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }

        .clear-button:hover {
            background-color: var(--red-clear-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            h2 {
                font-size: 1.5em;
            }

            .button-group {
                flex-direction: column; /* Stack buttons vertically on small screens */
                gap: 10px;
            }

            .action-button {
                width: 100%; /* Full width buttons */
                padding: 12px 20px;
                font-size: 1.1em;
            }

            .classify-button {
                padding: 15px 30px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Waste Classifier</h1>

        <div class="upload-section card">
            <h2>Upload or Paste Waste Image</h2>
            <div class="button-group">
                <label for="imageUpload" class="action-button upload-button">Choose Image</label>
                <input type="file" id="imageUpload" accept="image/*" class="hidden-input">
                <button id="pasteImageBtn" class="action-button paste-button">Paste from Clipboard</button>
            </div>
            <p class="upload-hint">Or, directly paste an image from your clipboard.</p>
        </div>

        <div class="image-preview card">
            <h2>Image Preview</h2>
            <img id="previewImage" src="#" alt="Image Preview">
            <p id="noImageText">No image selected</p>
        </div>

        <button id="classifyBtn" class="action-button classify-button" disabled>Classify Waste</button>

        <div class="result-section card">
            <h2>Classification Result:</h2>
            <p id="classificationResult">Upload an image to classify.</p>
            <div id="disposalTips">
                <h3>Disposal Advice:</h3>
                <p>Once classified, detailed disposal tips will be provided here.</p>
            </div>
        </div>

        <div class="history-section card">
            <h2>Classification History</h2>
            <ul id="historyList">
                <li>No history yet. Classify an item to start!</li>
            </ul>
            <button id="clearHistoryBtn" class="clear-button">Clear History</button>
        </div>
    </div>

    <script>
        // Get references to HTML elements
        const imageUpload = document.getElementById('imageUpload');
        const pasteImageBtn = document.getElementById('pasteImageBtn');
        const previewImage = document.getElementById('previewImage');
        const noImageText = document.getElementById('noImageText');
        const classifyBtn = document.getElementById('classifyBtn');
        const classificationResult = document.getElementById('classificationResult');
        const disposalTips = document.getElementById('disposalTips');
        const historyList = document.getElementById('historyList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        // Function to handle displaying an image
        function displayImage(imageUrl) {
            previewImage.src = imageUrl;
            previewImage.style.display = 'block';
            noImageText.style.display = 'none';
            classifyBtn.disabled = false; // Enable classify button
        }

        // Event listener for image file selection
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    displayImage(e.target.result);
                };
                reader.readAsDataURL(file);
            } else {
                // If no file selected, reset preview
                previewImage.src = '#';
                previewImage.style.display = 'none';
                noImageText.style.display = 'block';
                classifyBtn.disabled = true; // Disable classify button
            }
        });

        // Event listener for pasting image from clipboard
        pasteImageBtn.addEventListener('click', async () => {
            try {
                // Clipboard API requires user permission and a secure context (HTTPS)
                // If running locally, you might need to enable a flag in your browser (e.g., Chrome: chrome://flags/#unsafely-treat-as-secure-origin)
                // or serve via a local web server (like `python -m http.server`) for it to work.
                const clipboardItems = await navigator.clipboard.read();
                let imageFound = false;
                for (const clipboardItem of clipboardItems) {
                    for (const type of clipboardItem.types) {
                        if (type.startsWith('image/')) {
                            const blob = await clipboardItem.getType(type);
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                displayImage(e.target.result);
                            };
                            reader.readAsDataURL(blob);
                            imageFound = true;
                            return; // Stop after finding the first image
                        }
                    }
                }
                if (!imageFound) {
                    alert("No image data found in clipboard. Please copy an image first.");
                }
            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                alert("Permission to read clipboard denied or no image found. Please ensure you've copied an image and granted clipboard permissions if prompted. (Clipboard paste might require HTTPS or local server for full functionality).");
            }
        });

        // --- AI Model and Classification ---
        // These libraries are crucial for the AI model to work.
        // They are dynamically loaded to keep everything in one file.
        let model; // To hold the loaded Teachable Machine model
        // IMPORTANT: Replace with YOUR Teachable Machine model URL
        const TM_URL = "https://teachablemachine.withgoogle.com/models/eg1OfKiX4/";

        async function loadWasteModel() {
            try {
                const modelURL = TM_URL + "model.json";
                const metadataURL = TM_URL + "metadata.json";
                // tmImage comes from the dynamically loaded Teachable Machine library
                model = await tmImage.load(modelURL, metadataURL);
                console.log("Teachable Machine Model Loaded Successfully!");
                // Optionally, update a status message on the page for the user
                // e.g., classificationResult.textContent = "AI Model Ready! Upload an image to classify.";
            } catch (error) {
                console.error("Failed to load Teachable Machine model:", error);
                classificationResult.textContent = "Error: AI model failed to load. Check console for details.";
                disposalTips.innerHTML = '<h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Disposal Advice:</h3><p>AI model could not be loaded. Please ensure your internet connection is active and the model URL is correct.</p>';
            }
        }

        // Function to get image from previewImage element for classification
        async function getImageForClassification() {
            if (previewImage.style.display === 'block' && previewImage.src !== '#') {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = previewImage.src;
                });
            }
            return null;
        }

        classifyBtn.addEventListener('click', async () => {
            classificationResult.textContent = "Classifying...";
            disposalTips.innerHTML = '<h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Disposal Advice:</h3><p>Processing your image...</p>';

            const image = await getImageForClassification();
            if (!image) {
                classificationResult.textContent = "No image to classify.";
                disposalTips.innerHTML = '<h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Disposal Advice:</h3><p>Please select or paste an image first.</p>';
                return;
            }

            if (!model) {
                // If model is null/undefined, it means it hasn't loaded yet or failed to load
                classificationResult.textContent = "AI model not loaded yet. Please wait a moment, then try again.";
                disposalTips.innerHTML = '<h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Disposal Advice:</h3><p>AI model is still loading or failed to load. Cannot classify.</p>';
                return;
            }

            try {
                const prediction = await model.predict(image);

                let maxProbability = 0;
                let predictedClass = "Unknown";

                prediction.forEach(p => {
                    if (p.probability > maxProbability) {
                        maxProbability = p.probability;
                        predictedClass = p.className;
                    }
                });

                classificationResult.textContent = `Classified as: ${predictedClass} (${(maxProbability * 100).toFixed(2)}%)`;
                displayDisposalTips(predictedClass);
                addToHistory(predictedClass, maxProbability);

            } catch (error) {
                console.error("Error during classification:", error);
                classificationResult.textContent = "Error classifying image. Please try again.";
                disposalTips.innerHTML = '<h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Disposal Advice:</h3><p>An error occurred during classification. Check browser console for details.</p>';
            }
        });

        // --- Disposal Tips Logic ---
        function displayDisposalTips(classification) {
            disposalTips.innerHTML = ''; // Clear previous tips
            let tips = '';

            switch (classification.toLowerCase()) {
                case 'recyclable': // Ensure this matches your Teachable Machine class name exactly
                    tips = `
                        <h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Recycling Guidelines:</h3>
                        <p style="margin-bottom: 10px; line-height: 1.6;">1. <b>Clean it:</b> Rinse containers (bottles, jars) to remove food residue. This prevents contamination.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">2. <b>Flatten it:</b> Compress plastic bottles and cardboard to save space in bins and transport.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">3. <b>Check Local Rules:</b> Always verify local recycling guidelines as accepted materials can vary by region.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">4. <b>No Contaminants:</b> Avoid putting items like plastic bags (unless specified), food-soiled paper, or hazardous waste in recycling.</p>
                    `;
                    break;
                case 'organic': // Ensure this matches your Teachable Machine class name exactly
                    tips = `
                        <h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Organic Waste Guidelines:</h3>
                        <p style="margin-bottom: 10px; line-height: 1.6;">1. <b>Compost if possible:</b> Food scraps (fruit/vegetable peels, coffee grounds, eggshells) are excellent for composting.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">2. <b>Use designated bins:</b> If your municipality has an organic waste collection, use their specific bins.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">3. <b>Avoid non-compostables:</b> Generally, avoid meat, dairy, bones, or oily foods in home compost bins.</p>
                    `;
                    break;
                case 'general': // Ensure this matches your Teachable Machine class name exactly
                    tips = `
                        <h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">General Waste Guidelines:</h3>
                        <p style="margin-bottom: 10px; line-height: 1.6;">1. <b>Last Resort:</b> This category is for items that cannot be recycled or composted.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">2. <b>Bag Appropriately:</b> Ensure waste is securely bagged to prevent spills and odors.</p>
                        <p style="margin-bottom: 10px; line-height: 1.6;">3. <b>Minimize:</b> Try to reduce general waste by opting for reusable items and choosing products with less packaging.</p>
                    `;
                    break;
                default:
                    tips = `
                        <h3 style="color: #1B5E20; margin-bottom: 12px; font-size: 1.3em;">Disposal Advice:</h3>
                        <p style="margin-bottom: 10px; line-height: 1.6;">Classification uncertain. Please consult your local waste management guide for proper disposal of this item.</p>
                    `;
                    break;
            }
            disposalTips.innerHTML = tips;
        }

        // --- History Management ---
        function addToHistory(classification, probability) {
            const historyItem = document.createElement('li');
            const timestamp = new Date().toLocaleString();
            historyItem.textContent = `${timestamp}: Classified as ${classification} (Prob: ${(probability * 100).toFixed(2)}%)`;
            historyItem.style = "padding: 12px 20px; border-bottom: 1px solid var(--border-light); color: var(--text-medium); font-size: 0.95em; display: flex; justify-content: space-between; align-items: center;"; // Apply history item style
            historyList.prepend(historyItem); // Add to the top

            // Store history in Local Storage (for persistence across sessions)
            let history = JSON.parse(localStorage.getItem('wasteHistory')) || [];
            history.unshift({ classification, probability, timestamp });
            localStorage.setItem('wasteHistory', JSON.stringify(history));

            // Remove the "No history yet" placeholder if present and there's more than one item
            if (historyList.children.length > 1 && historyList.lastElementChild && historyList.lastElementChild.textContent.includes("No history yet")) {
                historyList.removeChild(historyList.lastElementChild);
            }
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('wasteHistory')) || [];
            historyList.innerHTML = ''; // Clear initial placeholder
            if (history.length === 0) {
                 historyList.innerHTML = '<li style="padding: 12px 20px; border-bottom: 1px solid var(--border-light); color: var(--text-medium); font-size: 0.95em; display: flex; justify-content: space-between; align-items: center;">No history yet. Classify an item to start!</li>'; // Apply history item style
            } else {
                history.forEach(item => {
                    const historyItem = document.createElement('li');
                    historyItem.textContent = `${item.timestamp}: Classified as ${item.classification} (Prob: ${(item.probability * 100).toFixed(2)}%)`;
                    historyItem.style = "padding: 12px 20px; border-bottom: 1px solid var(--border-light); color: var(--text-medium); font-size: 0.95em; display: flex; justify-content: space-between; align-items: center;"; // Apply history item style
                    historyList.appendChild(historyItem);
                });
            }
        }

        clearHistoryBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all classification history?")) {
                localStorage.removeItem('wasteHistory');
                historyList.innerHTML = '<li style="padding: 12px 20px; border-bottom: 1px solid var(--border-light); color: var(--text-medium); font-size: 0.95em; display: flex; justify-content: space-between; align-items: center;">No history yet. Classify an item to start!</li>'; // Apply history item style
                alert("History cleared!");
            }
        });

        // Initialize on page load
        window.onload = async () => {
            // Dynamically load TensorFlow.js and Teachable Machine libraries
            // This is critical for the AI model to function and needs an internet connection.
            const tfjsScript = document.createElement('script');
            tfjsScript.src = "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js";
            tfjsScript.async = true; // Load asynchronously to not block page rendering
            tfjsScript.onload = () => {
                const tmImageScript = document.createElement('script');
                tmImageScript.src = "https://cdn.jsdelivr.net/npm/@tensorflow-models/tm-image@latest/dist/tm-image.min.js";
                tmImageScript.async = true; // Load asynchronously
                tmImageScript.onload = loadWasteModel; // Load your model AFTER tmImage is loaded
                document.head.appendChild(tmImageScript);
            };
            document.head.appendChild(tfjsScript);

            loadHistory(); // Load history from local storage when the page loads
        };
    </script>

</body>
</html>
